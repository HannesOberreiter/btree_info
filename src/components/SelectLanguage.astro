---
const curLoc = Astro.currentLocale;
---

<div class="flex items-center gap-1">
  <button
    class={`bg-transparent border-none px-1 py-1 cursor-pointer text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors duration-300 ${
      curLoc === 'en' || !curLoc ? 'text-gray-900 dark:text-gray-100 font-bold' : ''
    }`}
    data-lang="en"
    title="Switch to English"
    aria-label="Switch to English"
  >
    EN
  </button>
  <span class="text-gray-300 dark:text-gray-600 select-none">|</span>
  <button
    class={`bg-transparent border-none px-1 py-1 cursor-pointer text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors duration-300 ${
      curLoc === 'de' ? 'text-gray-900 dark:text-gray-100 font-bold' : ''
    }`}
    data-lang="de"
    title="Wechseln Sie zu Deutsch"
    aria-label="Wechseln Sie zu Deutsch"
  >
    DE
  </button>
</div>

<script>
const buttons = document.querySelectorAll('[data-lang]') as NodeListOf<HTMLButtonElement>;
buttons.forEach((button) => {
  button.addEventListener('click', () => {
    changeLanguage(button.dataset.lang!);
  });
});

function changeLanguage(lang: string) {
  // Set flag to prevent automatic redirects after manual language selection
  localStorage.setItem('language-preference-set', 'true');

  const [_leadingSlash, oldLang, ...rest]
    = window.location.pathname.split('/');
  if (lang === 'en') {
    const slug = rest.join('/');
    window.location.pathname = `/${slug}`;
    return;
  }
  const slug = [oldLang, ...rest].join('/');
  window.location.pathname = `/${lang}/${slug}`;
}
</script>
